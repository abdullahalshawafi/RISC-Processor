LIBRARY IEEE;
USE IEEE.std_logic_1164.ALL;
USE IEEE.numeric_std.ALL;

ENTITY register_file IS
    GENERIC (n : INTEGER := 32);
    PORT (
        clk, rst : IN STD_LOGIC;
        reg_write : IN STD_LOGIC;
        Rs_address, Rt_address : IN STD_LOGIC_VECTOR(2 DOWNTO 0);
        Rd_address : IN STD_LOGIC_VECTOR(2 DOWNTO 0);
        Wd : IN STD_LOGIC_VECTOR(15 DOWNTO 0);
        Rs_data, Rt_data : OUT STD_LOGIC_VECTOR(15 DOWNTO 0)
    );

END register_file;

ARCHITECTURE register_file_arch OF register_file IS

    COMPONENT register_component IS
        PORT (
            reg_in : IN STD_LOGIC_VECTOR (n - 1 DOWNTO 0);
            clk, rst : IN STD_LOGIC;
            reg_out : OUT STD_LOGIC_VECTOR (n - 1 DOWNTO 0)
        );

    END COMPONENT;

    TYPE reg_type IS ARRAY(0 TO 7) OF STD_LOGIC_VECTOR(15 DOWNTO 0);
    SIGNAL reg_in, reg_out, reg_out_withoutWB : reg_type;
    SIGNAL reg_out_withWB : STD_LOGIC_VECTOR(15 DOWNTO 0);

BEGIN

    -- reg_in(to_integer(unsigned((Rd_address)))) <= Wd WHEN (reg_write = '1');
    -- reg_in(0) <= Wd WHEN (Rd_address = "000" AND reg_write = '1');
    -- reg_in(1) <= Wd WHEN (Rd_address = "001" AND reg_write = '1');
    -- reg_in(2) <= Wd WHEN (Rd_address = "010" AND reg_write = '1');
    -- reg_in(3) <= Wd WHEN (Rd_address = "011" AND reg_write = '1');
    -- reg_in(4) <= Wd WHEN (Rd_address = "100" AND reg_write = '1');
    -- reg_in(5) <= Wd WHEN (Rd_address = "101" AND reg_write = '1');
    -- reg_in(6) <= Wd WHEN (Rd_address = "110" AND reg_write = '1');
    -- reg_in(7) <= Wd WHEN (Rd_address = "111" AND reg_write = '1');

    loop1 : FOR i IN 0 TO (7) GENERATE

        IF (i = to_integer(unsigned((Rd_address))) AND reg_write = '1') THEN
            ry : register_component GENERIC MAP(n => 16) PORT MAP(Wd, clk, rst, reg_out(i));
        ELSE
            rx : register_component GENERIC MAP(n => 16) PORT MAP(reg_in(i), clk, rst, reg_out(i));
        END IF;
    END GENERATE;

    -- if write back occured 
    -- ry : register_component GENERIC MAP(n => 16) PORT MAP(Wd, clk, rst, reg_out_withWB);

    -- loop2 : FOR i IN 0 TO (7) GENERATE
    --     reg_out(i) <= reg_out_withoutWB(i);
    -- END GENERATE;
    -- reg_out <= reg_out_withoutWB;
    --  reg_out(0) <= reg_out_withWB WHEN (reg_write = '1');
    -- ELSE
    --     reg_out(to_integer(unsigned((Rd_address))));

    Rs_data <= reg_out(0) WHEN (Rs_address = "000")
        ELSE
        reg_out(1) WHEN (Rs_address = "001")
        ELSE
        reg_out(2) WHEN (Rs_address = "010")
        ELSE
        reg_out(3) WHEN (Rs_address = "011")
        ELSE
        reg_out(4) WHEN (Rs_address = "100")
        ELSE
        reg_out(5) WHEN (Rs_address = "101")
        ELSE
        reg_out(6) WHEN (Rs_address = "110")
        ELSE
        reg_out(7);

    Rt_data <= reg_out(0) WHEN (Rt_address = "000")
        ELSE
        reg_out(1) WHEN (Rt_address = "001")
        ELSE
        reg_out(2) WHEN (Rt_address = "010")
        ELSE
        reg_out(3) WHEN (Rt_address = "011")
        ELSE
        reg_out(4) WHEN (Rt_address = "100")
        ELSE
        reg_out(5) WHEN (Rt_address = "101")
        ELSE
        reg_out(6) WHEN (Rt_address = "110")
        ELSE
        reg_out(7);
END register_file_arch;